name: Publish to PyPI on main push

on:
  push:
    branches: ["main"]

concurrency:
  group: pypi-publish-main
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history and tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide bump from PR labels (major/minor/patch)
        id: bump
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # PR이 아닌 direct push면 빈 배열이 올 수 있음
          PR_JSON="$(curl -sS \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls")"

          export PR_JSON

          python - <<'PY'
          import json, os

          prs = json.loads(os.environ.get("PR_JSON", "[]"))
          bump = "patch"

          # 여러 PR이 잡히는 경우가 있어도, 보통 첫 번째가 해당 merge PR
          if prs:
            labels = [l["name"].lower() for l in prs[0].get("labels", [])]
            if "major" in labels:
              bump = "major"
            elif "minor" in labels:
              bump = "minor"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"bump={bump}\n")

          print("bump =", bump)
          PY

      - name: Create and push next version tag
        id: tag
        run: |
          set -euo pipefail

          last_tag="$(git tag --list 'v*' --sort=-v:refname | head -n 1 || true)"
          if [ -z "$last_tag" ]; then
            last_ver="0.0.0"
          else
            last_ver="${last_tag#v}"
          fi

          bump="${{ steps.bump.outputs.bump }}"

          new_ver="$(python - <<PY
          import re
          last="${last_ver}"
          bump="${bump}"

          m = re.match(r"^(\d+)\.(\d+)\.(\d+)$", last)
          if not m:
            raise SystemExit(f"invalid last version: {last}")

          maj, min_, pat = map(int, m.groups())

          if bump == "major":
            maj += 1
            min_ = 0
            pat = 0
          elif bump == "minor":
            min_ += 1
            pat = 0
          else:
            pat += 1

          print(f"{maj}.{min_}.{pat}")
          PY
          )"

          new_tag="v${new_ver}"

          # 안전장치: 태그가 이미 있으면 아무것도 하지 않음
          if git rev-parse "$new_tag" >/dev/null 2>&1; then
            echo "Tag already exists: $new_tag"
            echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
            echo "new_ver=$new_ver" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag -a "$new_tag" -m "Release $new_tag"
          git push origin "$new_tag"

          echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
          echo "new_ver=$new_ver" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build distributions
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Check distributions
        run: |
          python -m pip install --upgrade twine
          python -m twine check dist/*

      - name: Publish to PyPI (Trusted Publishing via OIDC)
        uses: pypa/gh-action-pypi-publish@release/v1
